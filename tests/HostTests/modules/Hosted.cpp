#include <HostTests.h>
#include <WHashMap.h>

#include <simpleRPC/parser.h>

using namespace simpleRPC;

class HostedTest : public TestGroup
{
public:
	using RemoteCommands = HashMap<String, uint8_t>;

	HostedTest() : TestGroup(_F("Hosted"))
	{
	}

	void execute() override
	{
		char packet[] = {
			0x73, 0x69, 0x6d, 0x70, 0x6c, 0x65, 0x52, 0x50, 0x43, 0x00, 0x03, 0x00, 0x00, 0x3c, 0x49, 0x00, 0x3a, 0x20,
			0x48, 0x20, 0x42, 0x3b, 0x70, 0x69, 0x6e, 0x4d, 0x6f, 0x64, 0x65, 0x3a, 0x20, 0x53, 0x65, 0x74, 0x73, 0x20,
			0x6d, 0x6f, 0x64, 0x65, 0x20, 0x6f, 0x66, 0x20, 0x64, 0x69, 0x67, 0x69, 0x74, 0x61, 0x6c, 0x20, 0x70, 0x69,
			0x6e, 0x2e, 0x20, 0x40, 0x70, 0x69, 0x6e, 0x3a, 0x20, 0x50, 0x69, 0x6e, 0x20, 0x6e, 0x75, 0x6d, 0x62, 0x65,
			0x72, 0x2c, 0x20, 0x40, 0x6d, 0x6f, 0x64, 0x65, 0x3a, 0x20, 0x4d, 0x6f, 0x64, 0x65, 0x20, 0x74, 0x79, 0x70,
			0x65, 0x2e, 0x00, 0x42, 0x3a, 0x20, 0x48, 0x3b, 0x64, 0x69, 0x67, 0x69, 0x74, 0x61, 0x6c, 0x52, 0x65, 0x61,
			0x64, 0x3a, 0x20, 0x52, 0x65, 0x61, 0x64, 0x20, 0x64, 0x69, 0x67, 0x69, 0x74, 0x61, 0x6c, 0x20, 0x70, 0x69,
			0x6e, 0x2e, 0x20, 0x40, 0x70, 0x69, 0x6e, 0x3a, 0x20, 0x50, 0x69, 0x6e, 0x20, 0x6e, 0x75, 0x6d, 0x62, 0x65,
			0x72, 0x2e, 0x20, 0x40, 0x72, 0x65, 0x74, 0x75, 0x72, 0x6e, 0x3a, 0x20, 0x50, 0x69, 0x6e, 0x20, 0x76, 0x61,
			0x6c, 0x75, 0x65, 0x2e, 0x00, 0x3a, 0x20, 0x48, 0x20, 0x42, 0x3b, 0x64, 0x69, 0x67, 0x69, 0x74, 0x61, 0x6c,
			0x57, 0x72, 0x69, 0x74, 0x65, 0x3a, 0x20, 0x57, 0x72, 0x69, 0x74, 0x65, 0x20, 0x74, 0x6f, 0x20, 0x61, 0x20,
			0x64, 0x69, 0x67, 0x69, 0x74, 0x61, 0x6c, 0x20, 0x70, 0x69, 0x6e, 0x2e, 0x20, 0x40, 0x70, 0x69, 0x6e, 0x3a,
			0x20, 0x50, 0x69, 0x6e, 0x20, 0x6e, 0x75, 0x6d, 0x62, 0x65, 0x72, 0x2e, 0x20, 0x40, 0x76, 0x61, 0x6c, 0x75,
			0x65, 0x3a, 0x20, 0x50, 0x69, 0x6e, 0x20, 0x76, 0x61, 0x6c, 0x75, 0x65, 0x2e, 0x00, 0x00};

		ParserSettings settings;
		settings.startMethods = ParserSettings::SimpleMethod(&HostedTest::startMethods, this);
		settings.startMethod = ParserSettings::SimpleMethod(&HostedTest::startMethod, this);
		settings.methodName = ParserSettings::CharMethod(&HostedTest::methodName, this);
		settings.endMethod = ParserSettings::SimpleMethod(&HostedTest::endMethod, this);
		settings.endMethods = ParserSettings::SimpleMethod(&HostedTest::endMethods, this);
		settings.state = ParserState::ready;

		TEST_CASE("simpleRPC::parse()")
		{
			REQUIRE(parse(settings, packet, sizeof(packet)) == ParserResult::finished);
			REQUIRE(commands.count() == 3);
			REQUIRE(commands["digitalWrite"] == 2);
			REQUIRE(commands["pinMode"] != 2);
			REQUIRE(commands["pinMode"] == 0);
		}
	}

private:
	RemoteCommands commands;
	uint8_t methodPosition = 0;
	String parsedCommand;

	void startMethods()
	{
		methodPosition = 0;
		commands.clear();
	}

	void startMethod()
	{
		parsedCommand = "";
	}

	void methodName(char ch)
	{
		parsedCommand += ch;
	}

	void endMethod()
	{
		commands[parsedCommand] = methodPosition++;
	}

	void endMethods()
	{
	}
};

void REGISTER_TEST(Hosted)
{
	registerGroup<HostedTest>();
}
